<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>EliteDesk - Tickets</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      body {
        background-color: #f4f6f9;
      }
      .card {
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        border-radius: 12px;
      }
      .badge-farol-verde {
        background-color: #28a745;
      }
      .badge-farol-amarelo {
        background-color: #ffc107;
        color: #000;
      }
      .badge-farol-vermelho {
        background-color: #dc3545;
      }
    </style>
  </head>
  <body>
    <div class="container my-4">
      <h1 class="mb-4">EliteDesk - Abertura de Tickets</h1>

      <div class="row g-4">
        <!-- FORMULÁRIO DE ABERTURA -->
        <div class="col-lg-4">
          <div class="card mb-3">
            <div class="card-header fw-bold">Novo Ticket</div>
            <div class="card-body">
              <form id="ticket-form">
                <div class="mb-2">
                  <label class="form-label">Empresa</label>
                  <input
                    type="text"
                    class="form-control"
                    id="empresa"
                    required
                  />
                </div>
                <div class="mb-2">
                  <label class="form-label">Setor</label>
                  <select class="form-select" id="setor" required>
                    <option value="">Carregando setores...</option>
                  </select>
                  <small class="text-muted"
                    >Os setores são carregados da API /setores.</small
                  >
                </div>

                <div class="mb-2">
                  <label class="form-label">Categoria</label>
                  <select class="form-select" id="categoria">
                    <option value="">Selecione um setor primeiro...</option>
                  </select>
                  <small class="text-muted">
                    Categorias são carregadas conforme o setor escolhido.
                  </small>
                </div>

                <div class="mb-2">
                  <label class="form-label">Título</label>
                  <input
                    type="text"
                    class="form-control"
                    id="titulo"
                    required
                  />
                </div>
                <div class="mb-2">
                  <label class="form-label">Descrição</label>
                  <textarea
                    class="form-control"
                    id="descricao"
                    rows="3"
                    required
                  ></textarea>
                </div>
                <div class="mb-2">
                  <label class="form-label">Prioridade</label>
                  <select class="form-select" id="prioridade" required>
                    <option value="baixa">Baixa</option>
                    <option value="media">Média</option>
                    <option value="alta">Alta</option>
                    <option value="critica">Crítica</option>
                  </select>
                </div>
                <div class="row mb-2">
                  <div class="col">
                    <label class="form-label">Prazo ideal</label>
                    <input
                      type="date"
                      class="form-control"
                      id="prazo_ideal"
                      required
                    />
                  </div>
                  <div class="col">
                    <label class="form-label">Prazo limite</label>
                    <input
                      type="date"
                      class="form-control"
                      id="prazo_limite"
                      required
                    />
                  </div>
                </div>

                <hr />

                <div class="mb-2">
                  <label class="form-label">Contato - Nome</label>
                  <input
                    type="text"
                    class="form-control"
                    id="contato_nome"
                    required
                  />
                </div>
                <div class="mb-2">
                  <label class="form-label">Contato - E-mail</label>
                  <input
                    type="email"
                    class="form-control"
                    id="contato_email"
                    required
                  />
                </div>
                <div class="mb-3">
                  <label class="form-label">Contato - Telefone</label>
                  <input
                    type="text"
                    class="form-control"
                    id="contato_telefone"
                    required
                  />
                </div>

                <button type="submit" class="btn btn-primary w-100">
                  Abrir Ticket
                </button>
              </form>

              <div id="mensagem" class="mt-3"></div>
            </div>
          </div>

          <!-- RESUMO SIMPLES -->
          <div class="card">
            <div class="card-header fw-bold">Resumo</div>
            <div class="card-body">
              <p class="mb-1">
                <strong>Total de tickets:</strong>
                <span id="resumo-total">-</span>
              </p>
              <p class="mb-1">
                <strong>Abertos:</strong> <span id="resumo-aberto">-</span>
              </p>
              <p class="mb-1">
                <strong>Em atendimento:</strong>
                <span id="resumo-em_atendimento">-</span>
              </p>
              <p class="mb-1">
                <strong>Aguardando:</strong>
                <span id="resumo-aguardando">-</span>
              </p>
              <p class="mb-1">
                <strong>Concluídos:</strong>
                <span id="resumo-concluido">-</span>
              </p>
              <p class="mb-0">
                <strong>Cancelados:</strong>
                <span id="resumo-cancelado">-</span>
              </p>
            </div>
          </div>
        </div>

        <!-- FILTROS + LISTAGEM + GRÁFICO -->
        <div class="col-lg-8">
          <div class="card mb-3">
            <div class="card-header fw-bold">Filtros</div>
            <div class="card-body">
              <div class="row g-2 align-items-end">
                <div class="col-md-4">
                  <label class="form-label">Status</label>
                  <select id="filtro-status" class="form-select">
                    <option value="">(Todos)</option>
                    <option value="aberto">Aberto</option>
                    <option value="em_atendimento">Em atendimento</option>
                    <option value="aguardando">Aguardando</option>
                    <option value="concluido">Concluído</option>
                    <option value="cancelado">Cancelado</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Setor</label>
                  <input
                    type="text"
                    id="filtro-setor"
                    class="form-control"
                    placeholder="Ex.: TI"
                  />
                </div>
                <div class="col-md-3">
                  <label class="form-label">Prioridade</label>
                  <select id="filtro-prioridade" class="form-select">
                    <option value="">(Todas)</option>
                    <option value="baixa">Baixa</option>
                    <option value="media">Média</option>
                    <option value="alta">Alta</option>
                    <option value="critica">Crítica</option>
                  </select>
                </div>
                <div class="col-md-1 d-grid">
                  <button id="btn-aplicar-filtros" class="btn btn-secondary">
                    OK
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="card mb-3">
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <span class="fw-bold">Tickets</span>
              <button
                id="btn-recarregar"
                class="btn btn-sm btn-outline-primary"
              >
                Recarregar
              </button>
            </div>
            <div class="card-body">
              <div class="table-responsive" style="max-height: 40vh">
                <table
                  class="table table-sm table-hover align-middle"
                  id="tabela-tickets"
                >
                  <thead class="table-light">
                    <tr>
                      <th>#</th>
                      <th>Protocolo</th>
                      <th>Título</th>
                      <th>Setor</th>
                      <th>Prioridade</th>
                      <th>Farol</th>
                      <th>Status</th>
                      <th>Abertura</th>
                      <th>Ações</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Linhas preenchidas via JS -->
                  </tbody>
                </table>
              </div>
              <small class="text-muted">
                * Dados carregados da API http://127.0.0.1:8000/tickets
              </small>
            </div>
          </div>

          <!-- GRÁFICO -->
          <div class="card">
            <div class="card-header fw-bold">Tickets por status</div>
            <div class="card-body">
              <canvas id="chart-status" height="120"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = "http://127.0.0.1:8000";

      const STATUS_OPTIONS = [
        { value: "aberto", label: "Aberto" },
        { value: "em_atendimento", label: "Em atendimento" },
        { value: "aguardando", label: "Aguardando" },
        { value: "concluido", label: "Concluído" },
        { value: "cancelado", label: "Cancelado" },
      ];

      const selectSetor = document.getElementById("setor");
      const selectCategoria = document.getElementById("categoria");
      let categoriasPorNome = {};

      const form = document.getElementById("ticket-form");
      const mensagemDiv = document.getElementById("mensagem");
      const tabelaBody = document.querySelector("#tabela-tickets tbody");
      const btnRecarregar = document.getElementById("btn-recarregar");
      const btnAplicarFiltros = document.getElementById("btn-aplicar-filtros");

      const filtroStatus = document.getElementById("filtro-status");
      const filtroSetor = document.getElementById("filtro-setor");
      const filtroPrioridade = document.getElementById("filtro-prioridade");

      // elementos do resumo
      const resumoTotal = document.getElementById("resumo-total");
      const resumoAberto = document.getElementById("resumo-aberto");
      const resumoEmAtendimento = document.getElementById(
        "resumo-em_atendimento"
      );
      const resumoAguardando = document.getElementById("resumo-aguardando");
      const resumoConcluido = document.getElementById("resumo-concluido");
      const resumoCancelado = document.getElementById("resumo-cancelado");

      let chartStatus = null;

      function limparFormulario() {
        form.reset();
      }

      function mostrarMensagem(tipo, texto) {
        mensagemDiv.innerHTML = `
        <div class="alert alert-${tipo} py-2 mb-0">
          ${texto}
        </div>
      `;
        setTimeout(() => (mensagemDiv.innerHTML = ""), 4000);
      }

      function badgeFarol(farol) {
        if (farol === "verde")
          return '<span class="badge badge-farol-verde">Verde</span>';
        if (farol === "amarelo")
          return '<span class="badge badge-farol-amarelo">Amarelo</span>';
        if (farol === "vermelho")
          return '<span class="badge badge-farol-vermelho">Vermelho</span>';
        return farol;
      }

      function montarSelectStatus(valorAtual) {
        let html = `<select class="form-select form-select-sm select-status">`;
        STATUS_OPTIONS.forEach((opt) => {
          const selected = opt.value === valorAtual ? "selected" : "";
          html += `<option value="${opt.value}" ${selected}>${opt.label}</option>`;
        });
        html += `</select>`;
        return html;
      }

      function formatDateToInput(d) {
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`; // formato aceito pelo input type="date"
      }

      function addDays(baseDate, days) {
        const d = new Date(baseDate);
        d.setDate(d.getDate() + days);
        return d;
      }

      async function atualizarStatus(id, novoStatus) {
        try {
          const resp = await fetch(`${API_BASE}/tickets/${id}/status`, {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ status: novoStatus }),
          });

          if (!resp.ok) {
            const erro = await resp.json();
            console.error(erro);
            mostrarMensagem("danger", "Erro ao atualizar status.");
            return;
          }

          mostrarMensagem("success", "Status atualizado com sucesso.");
          carregarTickets();
          carregarResumo();
        } catch (err) {
          console.error(err);
          mostrarMensagem(
            "danger",
            "Falha de comunicação com a API ao atualizar status."
          );
        }
      }

      async function carregarTickets() {
        tabelaBody.innerHTML = `<tr><td colspan="9">Carregando...</td></tr>`;

        const params = new URLSearchParams();
        if (filtroStatus.value) params.append("status", filtroStatus.value);
        if (filtroSetor.value) params.append("setor", filtroSetor.value);
        if (filtroPrioridade.value)
          params.append("prioridade", filtroPrioridade.value);

        const queryString = params.toString() ? `?${params.toString()}` : "";

        try {
          const resp = await fetch(`${API_BASE}/tickets${queryString}`);
          if (!resp.ok) {
            throw new Error("Erro ao buscar tickets");
          }
          const dados = await resp.json();

          if (dados.length === 0) {
            tabelaBody.innerHTML = `<tr><td colspan="9">Nenhum ticket encontrado.</td></tr>`;
            return;
          }

          tabelaBody.innerHTML = "";
          dados.forEach((t) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
            <td>${t.id}</td>
            <td>${t.numero_protocolo}</td>
            <td>${t.titulo}</td>
            <td>${t.setor}</td>
            <td>${t.prioridade}</td>
            <td>${badgeFarol(t.farol)}</td>
            <td>${t.status}</td>
            <td>${t.data_abertura}</td>
            <td>
              <div class="d-flex gap-1">
                ${montarSelectStatus(t.status)}
                <button class="btn btn-sm btn-outline-primary btn-atualizar-status">
                  Atualizar
                </button>
              </div>
            </td>
          `;

            const selectStatus = tr.querySelector(".select-status");
            const btnAtualizar = tr.querySelector(".btn-atualizar-status");

            btnAtualizar.addEventListener("click", () => {
              const novoStatus = selectStatus.value;
              atualizarStatus(t.id, novoStatus);
            });

            tabelaBody.appendChild(tr);
          });
        } catch (err) {
          console.error(err);
          tabelaBody.innerHTML = `<tr><td colspan="9">Erro ao carregar tickets.</td></tr>`;
        }
      }

      async function carregarResumo() {
        try {
          const resp = await fetch(`${API_BASE}/reports/summary`);
          if (!resp.ok) {
            throw new Error("Erro ao buscar resumo");
          }
          const dados = await resp.json();

          const byStatus = dados.by_status || {};

          resumoTotal.textContent = dados.total ?? 0;
          resumoAberto.textContent = byStatus.aberto ?? 0;
          resumoEmAtendimento.textContent = byStatus.em_atendimento ?? 0;
          resumoAguardando.textContent = byStatus.aguardando ?? 0;
          resumoConcluido.textContent = byStatus.concluido ?? 0;
          resumoCancelado.textContent = byStatus.cancelado ?? 0;

          // gráfico de barras
          const ctx = document.getElementById("chart-status").getContext("2d");
          const labels = STATUS_OPTIONS.map((o) => o.label);
          const values = STATUS_OPTIONS.map((o) => byStatus[o.value] ?? 0);

          if (chartStatus) {
            chartStatus.destroy();
          }

          chartStatus = new Chart(ctx, {
            type: "bar",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Tickets por status",
                  data: values,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  display: false,
                },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  precision: 0,
                },
              },
            },
          });
        } catch (err) {
          console.error(err);
        }
      }

      async function carregarSetores() {
        try {
          const resp = await fetch(`${API_BASE}/setores`);
          if (!resp.ok) {
            throw new Error("Erro ao buscar setores");
          }
          const setores = await resp.json();

          if (!setores.length) {
            selectSetor.innerHTML = `<option value="">Nenhum setor cadastrado</option>`;
            return;
          }

          selectSetor.innerHTML = `<option value="">Selecione...</option>`;
          setores.forEach((s) => {
            const opt = document.createElement("option");
            opt.value = s.nome; // vamos gravar o NOME no ticket
            opt.textContent = s.nome;
            selectSetor.appendChild(opt);
          });
        } catch (err) {
          console.error(err);
          selectSetor.innerHTML = `<option value="">Erro ao carregar setores</option>`;
        }
      }

      async function carregarCategorias(setorNome) {
        categoriasPorNome = {};

        if (!setorNome) {
          selectCategoria.innerHTML = `<option value="">Selecione um setor primeiro...</option>`;
          selectCategoria.disabled = true;
          return;
        }

        try {
          const resp = await fetch(
            `${API_BASE}/categorias?setor_nome=${encodeURIComponent(setorNome)}`
          );
          if (!resp.ok) {
            throw new Error("Erro ao buscar categorias");
          }
          const categorias = await resp.json();

          if (!categorias.length) {
            selectCategoria.innerHTML = `<option value="">Nenhuma categoria cadastrada para este setor</option>`;
            selectCategoria.disabled = true;
            return;
          }

          selectCategoria.disabled = false;
          selectCategoria.innerHTML = `<option value="">Selecione...</option>`;
          categorias.forEach((c) => {
            categoriasPorNome[c.nome] = c;
            const opt = document.createElement("option");
            opt.value = c.nome;
            opt.textContent = c.nome;
            selectCategoria.appendChild(opt);
          });
        } catch (err) {
          console.error(err);
          selectCategoria.innerHTML = `<option value="">Erro ao carregar categorias</option>`;
          selectCategoria.disabled = true;
        }
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const payload = {
          empresa: document.getElementById("empresa").value,
          setor: document.getElementById("setor").value,
          categoria_nome: document.getElementById("categoria").value || null,
          titulo: document.getElementById("titulo").value,
          descricao: document.getElementById("descricao").value,
          prioridade: document.getElementById("prioridade").value,
          prazo_ideal: document.getElementById("prazo_ideal").value,
          prazo_limite: document.getElementById("prazo_limite").value,
          contato_nome: document.getElementById("contato_nome").value,
          contato_email: document.getElementById("contato_email").value,
          contato_telefone: document.getElementById("contato_telefone").value,
        };

        try {
          const resp = await fetch(`${API_BASE}/tickets`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          if (!resp.ok) {
            const erro = await resp.json();
            console.error(erro);
            mostrarMensagem(
              "danger",
              "Erro ao criar ticket. Verifique os campos."
            );
            return;
          }

          const ticket = await resp.json();
          mostrarMensagem(
            "success",
            `Ticket criado com sucesso! Protocolo: ${ticket.numero_protocolo}`
          );
          limparFormulario();
          carregarTickets();
          carregarResumo();
        } catch (err) {
          console.error(err);
          mostrarMensagem("danger", "Falha de comunicação com a API.");
        }
      });

      btnRecarregar.addEventListener("click", () => {
        carregarTickets();
        carregarResumo();
      });

      btnAplicarFiltros.addEventListener("click", carregarTickets);

      selectSetor.addEventListener("change", () => {
        const setorSelecionado = selectSetor.value;
        // limpa categoria e prazos
        selectCategoria.innerHTML = `<option value="">Carregando categorias...</option>`;
        document.getElementById("prazo_ideal").value = "";
        document.getElementById("prazo_limite").value = "";
        carregarCategorias(setorSelecionado);
      });

      selectCategoria.addEventListener("change", () => {
        const nomeCategoria = selectCategoria.value;
        const categoria = categoriasPorNome[nomeCategoria];
        if (!categoria) {
          return;
        }

        const hoje = new Date();

        const prazoIdealDate = addDays(hoje, categoria.sla_dias_ideal ?? 0);
        const prazoLimiteDate = addDays(hoje, categoria.sla_dias_limite ?? 0);

        document.getElementById("prazo_ideal").value =
          formatDateToInput(prazoIdealDate);
        document.getElementById("prazo_limite").value =
          formatDateToInput(prazoLimiteDate);
      });

      // Carrega dados ao abrir a página
      carregarSetores();
      carregarTickets();
      carregarResumo();
    </script>
  </body>
</html>
